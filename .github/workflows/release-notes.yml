name: Generate Release Notes

on:
  release:
    types: [published]

jobs:
  generate_notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate release notes
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: context.payload.release.tag_name
            });

            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.release.target_commitish
            });

            let notes = `##  Release Notes for ${release.tag_name}\n\n`;
            notes += `###  New Features / Changes:\n`;
            commits.slice(0, 10).forEach(c => {
              notes += `- ${c.commit.message}\n`;
            });
            notes += `\nGenerated automatically by GitHub Actions.`;

            require("fs").writeFileSync("RELEASE_NOTES.md", notes);
            core.setOutput("notes", notes);

      - name: Commit and push notes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RELEASE_NOTES.md
          git commit -m " Add release notes for ${{ github.event.release.tag_name }}"
          git push

      - name: Upload release notes as artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
